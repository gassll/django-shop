{% extends 'base.html' %}
{% load static %}

{% block title %}–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π{% endblock %}

{% block content %}
    <div class="container px-4 py-5 bg-gradient min-vh-100"
         style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
        <!-- Header -->
        <div class="row mb-5 align-items-center">
            <div class="col-md-6">
                <h1 class="display-4 fw-bold text-dark mb-2">
                    <i class="bi bi-folder2-open me-3 text-primary"></i>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
                </h1>
                <p class="lead text-muted mb-0 fs-5">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –õ–ö–ú –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</p>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <a href="{% url 'catalog:category_form' %}"
                   class="btn btn-primary btn-lg px-5 py-3 shadow-lg">
                    <i class="bi bi-plus-circle-fill me-3"></i>
                    –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                </a>
            </div>
        </div>

        <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ï–¢–ö–ê —Å ID -->
        <div class="row g-4" id="categories-grid">
            {% for category in object_list %}
                <div class="col-xl-4 col-lg-6 col-md-8 col-sm-12 sortable-item" data-id="{{ category.id }}">
                    <div class="card border-0 shadow-xl h-100 category-card position-relative overflow-hidden draggable">
                        <!-- Drag handle -->
                        <div class="drag-handle position-absolute top-0 end-0 p-2 bg-primary bg-opacity-75 draggable-icon d-none">
                            <i class="bi bi-grip-vertical text-white fs-5"></i>
                        </div>

                        <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                        <div class="category-gradient"
                             style="background-image:url('{% static 'img/' %}{{ category.slug }}.avif');
                                     background-size: cover;
                                     background-position: center;
                                     height: 200px;">
                            <div class="position-absolute bottom-0 start-0 p-4">
                                <span class="badge bg-dark shadow-sm fs-6 px-3 py-2 fw-bold">
                                    #{{ category.pk }}
                                </span>
                            </div>
                        </div>

                        <div class="card-body p-4 d-flex flex-column">
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                            <div class="mb-4">
                                <h3 class="card-title fw-bold text-dark mb-2 lh-sm clamp-2">{{ category.name }}</h3>
                                <div class="d-flex align-items-center text-muted mb-2">
                                    <i class="bi bi-box-seam-fill me-2"></i>
                                    <span>{{ category.products.count }} —Ç–æ–≤–∞—Ä–æ–≤</span>
                                </div>
                            </div>

                            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                            <p class="card-text text-muted flex-grow-1 mb-4 clamp-3 lh-lg">
                                {{ category.description|truncatewords:20|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" }}
                            </p>

                            <!-- –°—Ç–∞—Ç—É—Å -->
                            <div class="mb-4">
                                {% if category.products.exists %}
                                    <span class="badge bg-success fs-6 px-3 py-2 shadow-sm">
                                        <i class="bi bi-check-circle-fill me-1"></i>–ê–∫—Ç–∏–≤–Ω–∞
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning fs-6 px-3 py-2 shadow-sm">
                                        <i class="bi bi-clock me-1"></i>–ü—É—Å—Ç–∞—è
                                    </span>
                                {% endif %}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                            <div class="d-flex gap-2 mt-auto">
                                <a href="{% url 'catalog:category_detail' category.pk %}"
                                   class="btn btn-outline-primary flex-fill btn-sm py-2"
                                   title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'catalog:category_update' category.pk %}"
                                   class="btn btn-outline-warning flex-fill btn-sm py-2"
                                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'catalog:category_delete' category.pk %}"
                                   class="btn btn-outline-danger flex-fill btn-sm py-2"
                                   title="–£–¥–∞–ª–∏—Ç—å"
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´{{ category.name|escapejs }}¬ª?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12 text-center py-8">
                    <div class="bg-white rounded-4 p-8 shadow-xl">
                        <i class="bi bi-folder-x display-1 text-muted mb-4 d-block"></i>
                        <h3 class="text-muted mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</h3>
                        <p class="text-muted mb-5 fs-5">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤</p>
                        <a href="{% url 'catalog:category_form' %}" class="btn btn-primary btn-lg px-6 py-3">
                            <i class="bi bi-plus-circle me-2"></i>
                            –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if is_paginated %}
            <div class="row mt-5">
                <!-- –≤–∞—à–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è -->
            </div>
        {% endif %}
    </div>

    <form style="display: none;">{% csrf_token %}</form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Drag & Drop –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

            let draggedItem = null;
            const grid = document.getElementById('categories-grid');

            if (!grid) {
                console.error('‚ùå –ù–ï –ù–ê–ô–î–ï–ù #categories-grid!');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è URL –¥–ª—è reorder
            const reorderUrl = "{% url 'catalog:category_reorder' %}";
            if (!reorderUrl || reorderUrl === '') {
                console.error('‚ùå URL –¥–ª—è reorder –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!');
                return;
            }

            const sortableItems = document.querySelectorAll('.sortable-item');
            console.log('üì¶ –ù–∞–π–¥–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', sortableItems.length);

            if (sortableItems.length === 0) {
                console.log('‚ÑπÔ∏è –ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏');
                return;
            }

            sortableItems.forEach(item => {
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—Å—Ç—å data-id
                if (!item.dataset.id) {
                    console.warn('‚ö†Ô∏è –ö–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ data-id, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }

                item.draggable = true;
                console.log('‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ ID:', item.dataset.id);

                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä—É—á–∫—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                item.addEventListener('mouseenter', () => {
                    const handle = item.querySelector('.drag-handle');
                    if (handle) handle.classList.remove('d-none');
                });

                item.addEventListener('mouseleave', () => {
                    if (!item.classList.contains('dragging')) {
                        const handle = item.querySelector('.drag-handle');
                        if (handle) handle.classList.add('d-none');
                    }
                });

                item.addEventListener('dragstart', (e) => {
                    console.log('üéØ –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è:', item.dataset.id);
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', item.dataset.id);

                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                    setTimeout(() => {
                        e.target.style.opacity = '0.8';
                    }, 0);
                });

                item.addEventListener('dragend', (e) => {
                    console.log('üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
                    item.classList.remove('dragging');
                    item.style.opacity = '1';

                    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ä—É—á–∫–∏
                    document.querySelectorAll('.drag-handle').forEach(handle => {
                        handle.classList.add('d-none');
                    });

                    draggedItem = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è
                    if (draggedItem && draggedItem !== item) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    console.log('üí• Drop –Ω–∞:', item.dataset.id);

                    if (draggedItem && draggedItem !== item) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∫–µ
                        const allItems = [...grid.children];
                        const draggedIndex = allItems.indexOf(draggedItem);
                        const targetIndex = allItems.indexOf(item);

                        if (draggedIndex < targetIndex) {
                            grid.insertBefore(draggedItem, item.nextSibling);
                        } else {
                            grid.insertBefore(draggedItem, item);
                        }

                        saveOrder();
                    }

                    item.classList.remove('drag-over');
                });
            });

            window.saveOrder = function () {
                const items = grid.querySelectorAll('.sortable-item[data-id]');
                const order = Array.from(items).map(item => parseInt(item.dataset.id));

                console.log('üÜï –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫:', order);
                console.log('üì° URL:', reorderUrl);

                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                if (saveOrder.isSaving) {
                    console.log('‚è≥ –£–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...');
                    return;
                }

                saveOrder.isSaving = true;

                fetch(reorderUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({order: order})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª:', data);
                        if (data.status === 'success') {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                            showNotification('–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                        } else {
                            throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ AJAX:', error);
                        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞!', 'error');
                    })
                    .finally(() => {
                        saveOrder.isSaving = false;
                    });
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
            const style = document.createElement('style');
            style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
            document.head.appendChild(style);

            console.log('‚úÖ Drag & Drop –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤!');
        });
    </script>

    <style>
        .category-card {
            border-radius: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.95);
            cursor: grab;
            user-select: none;
        }

        .category-card:active {
            cursor: grabbing !important;
        }

        .category-card:hover {
            transform: translateY(-16px) rotateX(5deg);
            box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.25) !important;
        }

        .drag-handle {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: grab;
        }

        .dragging {
            opacity: 0.8 !important;
            transform: rotate(5deg) scale(1.05) !important;
            z-index: 1000 !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3) !important;
        }

        .drag-over .category-card {
            transform: scale(1.02) !important;
            border: 3px dashed #007bff !important;
            background: rgba(0, 123, 255, 0.08) !important;
        }

        .clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .shadow-xl {
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.18) !important;
        }

        .btn {
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
    </style>
{% endblock %}
